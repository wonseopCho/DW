{% load static %}
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- set a web app capable website -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<link rel="manifest" href="{% static 'js/manifest.json' %}">
<link rel="apple-touch-icon" href="{% static '/Images/gps.png' %}" />
<link rel="apple-touch-icon-precomposed" href="{% static '/Images/gps.png' %}" />
<link rel="shortcut icon" href="{% static '/Images/gps.png' %}" />

{% block headAddon %}
{% endblock %}

<title >{% block title %}Tripticle{% endblock %}</title>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="{% static 'popper.js/1.14.0/popper.min.js' %}"></script>
<script src="{% static 'bootstrap/4.0.0-beta.3/js/bootstrap.min.js' %}"></script>
<script src="{% static 'Sortable/Sortable.js' %}"></script>
<script src="{% static 'sweetalert/sweetalert.js' %}"></script>
<script src="{% static 'add-to-homescreen-master/src/addtohomescreen.js' %}"></script>
<link rel="stylesheet" type="text/css" href="{% static 'bootstrap/4.0.0-beta.3/css/bootstrap.min.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'bootstrap/additionalCSS/carousel.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'css/base.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'open-iconic-master/font/css/open-iconic-bootstrap.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'sweetalert/sweetalert.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'add-to-homescreen-master/style/addtohomescreen.css' %}" />

<style>
body{
  padding-top: 0;
}
a, a:active, a:link {
  text-decoration: none;
}

.overlay {
    height: 100%;
    width:100%;
    position: fixed;
    z-index: 999;
    top: 0;
    left: -100%;
    background-color: rgb(0,0,0);
    background-color: rgba(0,0,0, 0.5);
    overflow-x: hidden;
    transition: 0.5s;
}

.overlay-content {
    position: relative;
    top: 0;
    width: 400px;
    text-align: center;
    background-color: rgb(239, 239, 239);
}

.overlay div {
    padding: 10px;
    text-decoration: none;
    font-size: 20px;
    color: #818181;
    display: block;
    transition: 0.3s;
}

.overlay a:hover, .overlay a:focus {
    /*color: #f1f1f1;*/
}

.overlay .closebtn {
    padding: 0px;
    position: absolute;
    top: 0px;
    right: 0px;
    font-size: 40px;
}

.noneScroll {
  overflow: hidden;
}

.avatar {
    vertical-align: middle;
    width: 50px;
    height: 50px;
    border-radius: 50%;
}

.pageload {
  width: 100%;
  height: 2px;
  background-color: #ddd;
}

.pageloadbar {
  width: 10%;
  height: 2px;
  background-color: #4CAF50;
  text-align: center;
  line-height: 30px;
  color: white;
}

.is-invisible {
  opacity: 0;
}

.subscription-details {
  transition: opacity 1s;
}

pre code {
  word-break: break-word;
}

@media only screen and (max-width: 450px) {
  a {
    color: #333333;
    text-decoration: none;
  }
  .overlay .closebtn {
    font-size: 40px;
    top: 0px;
    right: 0px;
  }
  .overlay-content {
    width: 100%;
  }
}
</style>
<script>
var userAgent = navigator.userAgent.toLowerCase();
console.log(userAgent);

if(userAgent.match('iphone')) {
    console.log(1);
    document.write("<link href='{% static '/Images/gps.png' %}' rel='apple-touch-icon'>"); 
} else if(userAgent.match('ipad')) { // sizes="72*72"
    console.log(2);
    document.write("<link href='{% static '/Images/gps.png' %}' rel='apple-touch-icon'>");
} else if(userAgent.match('ipod')) {
    console.log(3);
    document.write("<link href='{% static '/Images/gps.png' %}' rel='apple-touch-icon'>"); 
} else if(userAgent.match('android')) {
    console.log(4);
    document.write("<link href='{% static '/Images/gps.png' %}' rel='shortcut icon'>"); 
} else {
    console.log(5);
    document.write("<link href='{% static '/Images/gps.png' %}' rel='shortcut icon'>"); 
};

addToHomescreen();// Especially for IOS

$(document).ready(function(){
  var width = 100, // width of a progress bar in percentage
      perfData = window.performance.timing, // The PerformanceTiming interface
      EstimatedTime = -(perfData.loadEventEnd - perfData.navigationStart), // Calculated Estimated Time of Page Load which returns negative value.
      time = parseInt((EstimatedTime/1000)%60)*100; //Converting EstimatedTime from miliseconds to seconds.
  // Loadbar Animation
  $(".pageloadbar").animate({
    width: width + "%"
  }, time/5, 
  function(){
    $(".pageload").css("background-color" , "white");
    $(".pageloadbar").css("display" , "none");
  });
});

function onLoad() { 
  var now = new Date().getTime();
  var page_load_time = now - performance.timing.navigationStart;
  console.log("User-perceived page loading time: " + page_load_time);
}
</script>
</head>
<body>
  <header>
    <div class="pageload">
      <div class="pageloadbar"></div>
    </div>
    
    <div id="myNav" class="overlay">
      <div class="overlay-content">
        <div class="closebtn" onclick="closeNav()" style="width:52px;">
          &times;
        </div>
        <!-- <div style="text-align: left">
          <a href='/'>&#127968;</a>
        </div> -->
          {% if user.is_authenticated %}
            <button type="button" id="myBtn"></button>
            <a href="{% url 'accounts:view_profile' %}">
              <div style="text-align: left">
                {% if authenticated_user.picture %}
                  <img src="{{authenticated_user.picture.url}}" class="avatar" style="margin-right: 10px;">
                {% elif authenticated_user.photo_url %}
                  <img src="{{authenticated_user.photo_url}}" class="avatar" style="margin-right: 10px;">
                {% else %}
                  {% if authenticated_user.gender == 'female' %}
                    <img src="{% static 'Images/accounts/avatars/img_avatar2.png' %}" class="avatar" alt="Avatar" />
                  {% else %}
                    <img src="{% static 'Images/accounts/avatars/img_avatar.png' %}" class="avatar" alt="Avatar" />
                  {% endif %}
                {% endif %}
                {{authenticated_user.user}}'s Profile 
              </div>
            </a>
            <div style="text-align: left">
              <a href="/logout?next={{ request.path }}">
                Log-Out
              </a>
            </div>
            {% if socialaccount is None %}
            <div style="text-align: left">
              <a href="{% url 'accounts:change_password' %}">
                Change Password
              </a>
            </div>
            {% endif %}
          {% else %}
            <button type="button" id="myBtn" style="display:none"></button>
            <a href="/login?next={{ request.path }}">
              <div style="text-align: left">
                <img src="{% static 'Images/accounts/avatars/img_avatar.png' %}" alt="Avatar" class="avatar" style="margin-right: 10px;">
                Log-In please
              </div>
            </a>
            <div style="text-align: left">
              <a href="{% url 'accounts:register' %}">
                Register
              </a>
            </div>  
            <div style="text-align: left">
              <a href="{% url 'accounts:reset_password' %}">
                Forgot Password?
              </a>
            </div>
          {% endif %}
        <div id='categories' style="border:1px solid #dddbdb; height: 250px; padding:0 ">
          {% for category in categories %}
            <div style="border: 0px solid black; width:33.3%; float:left; cursor:pointer" onclick="gotoCategory('{{category}}')">
              <img style="width:40px; height:40px" src="{{category.image.url}}"/>
              <span style="display:block;border:0px solid red; font-size: 13px">{{category|capfirst}}</span>
            </div>
          {% endfor %}
        </div>
        <div style="border:1px solid #dddbdb; height: 70px; ">
          <div style="border: 0px solid black; width:50%; float:left; font-size: 17px;">Announcement</div>
          <div style="border: 0px solid black; width:50%; float:left; font-size: 17px;">
            <a id="mapAPI" href="/mapAPI">MAP</a>
          </div>
        </div>
        <a class="nav-link" href="/blog">Blog</a>
        <a class="nav-link" href="/blog2">Blog2</a>
        <a class="nav-link" href="/bookmark">Bookmark</a>
      </div>
    </div>
    <div style="border:0px solid red; width:100%; height:54px">
      <div style="border:0px solid black; width:15%; text-align:center; float:left">
        <span style="font-size:35px;cursor:pointer" onclick="openNav()">&#9776;</span>
      </div>
      <div style="border:0px solid red; width:70%; text-align:center; float:left">
        <a href="/">
          <span style="font-size:35px;cursor:pointer">&#9819;</span>
        </a>
      </div>
      <div style="border:0px solid red; width:15%; text-align:center; float:left">
        <a href="{% url 'accounts:view_profile' %}">
          <span style="font-size:35px;cursor:pointer">&#9983;</span>
        </a>
      </div>
    </div>
    <script>
      var pushButton = document.getElementById("myBtn");

      const applicationServerPublicKey = 'BJajdmG_VQMSmpSMvjLWLowdqN-Rn1hkBwpz-Nkb2ZTI9y_rFfH1TBw3A4eMha4hm9P429Dl5AqONqVfZsmPHqI';
      
      let isSubscribed = false;
      let swRegistration = null;

      if ('serviceWorker' in navigator && 'PushManager' in window) {
          console.log('Service Worker and Push is supported');
          navigator.serviceWorker.register("/service-worker.js")
            .then(function(swReg){
              console.log('Service Worker is registered', swReg);
              swRegistration = swReg;
              initialiseUI();
           }).catch(function(err) {
              console.error('Service Worker Error', err)
          });
       } else {
          console.warn('Push messaging is not supported');
          pushButton.textContent = 'Push Not Supported';
      }

      function initialiseUI() {
        pushButton.addEventListener('click', function() {
            pushButton.disabled = true;
            if (isSubscribed) {
              // TODO: Unsubscribe user
              unsubscribeUser();
            } else {
              subscribeUser();
            }
          });

        // Set the initial subscription value
        swRegistration.pushManager.getSubscription()
        .then(function(subscription) {
          isSubscribed = !(subscription === null);

          if (isSubscribed) {
            console.log('User IS subscribed.');
          } else {
            console.log('User is NOT subscribed.');
          }

          updateBtn();
        });
      }

      function subscribeUser() {
        const applicationServerKey = urlB64ToUint8Array(applicationServerPublicKey);
        swRegistration.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: applicationServerKey
        })
        .then(function(subscription) {
          console.log('User is subscribed:', subscription);

          updateSubscriptionOnServer(subscription);

          isSubscribed = true;

          updateBtn();
        })
        .catch(function(err) {
          console.log('Failed to subscribe the user: ', err);
          updateBtn();
        });
      }

      function unsubscribeUser() {
        swRegistration.pushManager.getSubscription()
        .then(function(subscription) {
          if (subscription) {
            return subscription.unsubscribe();
          }
        })
        .catch(function(error) {
          console.log('Error unsubscribing', error);
        })
        .then(function() {
          updateSubscriptionOnServer(null);

          console.log('User is unsubscribed.');
          isSubscribed = false;

          updateBtn();
        });
      }

      function updateBtn() {
        if (Notification.permission === 'denied') {
            pushButton.textContent = 'Push Messaging Blocked.';
            pushButton.disabled = true;
            updateSubscriptionOnServer(null);
            return;
          }

        if (isSubscribed) {
          pushButton.textContent = 'Disable Push Messaging';
        } else {
          pushButton.textContent = 'Enable Push Messaging';
        }

        pushButton.disabled = false;
      }

      function urlB64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding)
          .replace(/\-/g, '+')
          .replace(/_/g, '/');

        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);

        for (let i = 0; i < rawData.length; ++i) {
          outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
      }

      function updateSubscriptionOnServer(subscription) {
        // TODO: Send subscription to application server
        if (subscription) {
          console.log(JSON.stringify(subscription));

          var subscribe = {};
          subscribe.csrfmiddlewaretoken = '{{csrf_token}}';
          subscribe.subscription = JSON.stringify(subscription);
          $.ajax({
            url:"{% url 'accounts:subscribe' %}",
            method:"post",
            data: subscribe,
            success: function(res){
              if (res == 1){
                console.log("subscription success");
              }
              else{
                console.log("subscription failed");
              }
            },error: function(error){
              console.log("error",error);
            }
          });
        }
      }

    function gotoCategory(category){
      setCookie('p_page', category, 1);
      location.href = '/';
    }

    function setCookie(cName, cValue, cDay){
        var expire = new Date();
        expire.setDate(expire.getDate() + cDay);
        cookies = cName + '=' + escape(cValue) + '; path=/ ';
        if(typeof cDay != 'undefined') cookies += ';expires=' + expire.toGMTString() + ';';
        document.cookie = cookies;
    }  

    function openNav() {
        $("#myNav").animate({left: '0px'}, 30);
        $('body').addClass('noneScroll');

    }

    function closeNav() {
        $("#myNav").animate({left: '-100%'}, 30);
        $('body').removeClass('noneScroll');
    }

    $("#mapAPI").click(function(){
      $("#myNav").animate({left: '-100%'}, 30);
    });
    </script>
  </header>
  	{% block content %}{% endblock %}
    {% block additional_script %}
    {% endblock %}
  	{% block footer %}{% endblock %}
</body>
</html>